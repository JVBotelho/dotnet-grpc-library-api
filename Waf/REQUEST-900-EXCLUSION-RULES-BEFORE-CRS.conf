# ------------------------------------------------------------------------
# CUSTOM RULES: .NET Core & Infrastructure Tuning
# ------------------------------------------------------------------------

# 1. HEALTH CHECKS
# Ignora checagens de saúde do Docker/K8s para não sujar logs ou bloquear
SecRule REQUEST_URI "@beginsWith /health" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# 2. STATIC ASSETS
# Ignora verificação em imagens e fontes para economizar CPU
# (Adicionado @rx explicitamente para garantir compatibilidade)
SecRule REQUEST_BASENAME "@rx \.(?:png|jpg|jpeg|gif|ico|css|js|svg|woff|woff2|ttf|eot)$" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# 3. ASP.NET CORE ANTIFORGERY TOKENS
# CORREÇÃO: Substituído o operador inválido @ne por !@rx ^$ (Não é vazio)
# Se o token existir e não for vazio, paramos de buscar SQLi/XSS dentro dele.
SecRule REQUEST_COOKIES|REQUEST_HEADERS:RequestVerificationToken "!@rx ^$" \
    "id:1003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:__RequestVerificationToken,\
    ctl:ruleRemoveTargetByTag=attack-xss;ARGS:__RequestVerificationToken,\
    ctl:ruleRemoveTargetByTag=attack-sqli;REQUEST_COOKIES:.AspNetCore.Antiforgery.,\
    ctl:ruleRemoveTargetByTag=attack-xss;REQUEST_COOKIES:.AspNetCore.Antiforgery."

# 4. SIGNALR / WEBSOCKETS
# Evita bloqueios de protocolo no handshake do WebSocket
SecRule REQUEST_HEADERS:Upgrade "@streq websocket" \
    "id:1004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920420,\
    ctl:ruleRemoveById=920280"